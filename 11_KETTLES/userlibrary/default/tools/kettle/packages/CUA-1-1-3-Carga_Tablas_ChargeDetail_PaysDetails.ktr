<?xml version="1.0" encoding="UTF-8"?>
<transformation>
  <info>
    <name>CUA-1-1-3-Carga_Tablas_ChargeDetail_PaysDetails</name>
    <description/>
    <extended_description/>
    <trans_version/>
    <trans_type>Normal</trans_type>
    <trans_status>0</trans_status>
    <directory>&#47;</directory>
    <parameters>
    </parameters>
    <log>
<trans-log-table><connection/>
<schema/>
<table/>
<size_limit_lines/>
<interval/>
<timeout_days/>
<field><id>ID_BATCH</id><enabled>Y</enabled><name>ID_BATCH</name></field><field><id>CHANNEL_ID</id><enabled>Y</enabled><name>CHANNEL_ID</name></field><field><id>TRANSNAME</id><enabled>Y</enabled><name>TRANSNAME</name></field><field><id>STATUS</id><enabled>Y</enabled><name>STATUS</name></field><field><id>LINES_READ</id><enabled>Y</enabled><name>LINES_READ</name><subject/></field><field><id>LINES_WRITTEN</id><enabled>Y</enabled><name>LINES_WRITTEN</name><subject/></field><field><id>LINES_UPDATED</id><enabled>Y</enabled><name>LINES_UPDATED</name><subject/></field><field><id>LINES_INPUT</id><enabled>Y</enabled><name>LINES_INPUT</name><subject/></field><field><id>LINES_OUTPUT</id><enabled>Y</enabled><name>LINES_OUTPUT</name><subject/></field><field><id>LINES_REJECTED</id><enabled>Y</enabled><name>LINES_REJECTED</name><subject/></field><field><id>ERRORS</id><enabled>Y</enabled><name>ERRORS</name></field><field><id>STARTDATE</id><enabled>Y</enabled><name>STARTDATE</name></field><field><id>ENDDATE</id><enabled>Y</enabled><name>ENDDATE</name></field><field><id>LOGDATE</id><enabled>Y</enabled><name>LOGDATE</name></field><field><id>DEPDATE</id><enabled>Y</enabled><name>DEPDATE</name></field><field><id>REPLAYDATE</id><enabled>Y</enabled><name>REPLAYDATE</name></field><field><id>LOG_FIELD</id><enabled>Y</enabled><name>LOG_FIELD</name></field></trans-log-table>
<perf-log-table><connection/>
<schema/>
<table/>
<interval/>
<timeout_days/>
<field><id>ID_BATCH</id><enabled>Y</enabled><name>ID_BATCH</name></field><field><id>SEQ_NR</id><enabled>Y</enabled><name>SEQ_NR</name></field><field><id>LOGDATE</id><enabled>Y</enabled><name>LOGDATE</name></field><field><id>TRANSNAME</id><enabled>Y</enabled><name>TRANSNAME</name></field><field><id>STEPNAME</id><enabled>Y</enabled><name>STEPNAME</name></field><field><id>STEP_COPY</id><enabled>Y</enabled><name>STEP_COPY</name></field><field><id>LINES_READ</id><enabled>Y</enabled><name>LINES_READ</name></field><field><id>LINES_WRITTEN</id><enabled>Y</enabled><name>LINES_WRITTEN</name></field><field><id>LINES_UPDATED</id><enabled>Y</enabled><name>LINES_UPDATED</name></field><field><id>LINES_INPUT</id><enabled>Y</enabled><name>LINES_INPUT</name></field><field><id>LINES_OUTPUT</id><enabled>Y</enabled><name>LINES_OUTPUT</name></field><field><id>LINES_REJECTED</id><enabled>Y</enabled><name>LINES_REJECTED</name></field><field><id>ERRORS</id><enabled>Y</enabled><name>ERRORS</name></field><field><id>INPUT_BUFFER_ROWS</id><enabled>Y</enabled><name>INPUT_BUFFER_ROWS</name></field><field><id>OUTPUT_BUFFER_ROWS</id><enabled>Y</enabled><name>OUTPUT_BUFFER_ROWS</name></field></perf-log-table>
<channel-log-table><connection/>
<schema/>
<table/>
<timeout_days/>
<field><id>ID_BATCH</id><enabled>Y</enabled><name>ID_BATCH</name></field><field><id>CHANNEL_ID</id><enabled>Y</enabled><name>CHANNEL_ID</name></field><field><id>LOG_DATE</id><enabled>Y</enabled><name>LOG_DATE</name></field><field><id>LOGGING_OBJECT_TYPE</id><enabled>Y</enabled><name>LOGGING_OBJECT_TYPE</name></field><field><id>OBJECT_NAME</id><enabled>Y</enabled><name>OBJECT_NAME</name></field><field><id>OBJECT_COPY</id><enabled>Y</enabled><name>OBJECT_COPY</name></field><field><id>REPOSITORY_DIRECTORY</id><enabled>Y</enabled><name>REPOSITORY_DIRECTORY</name></field><field><id>FILENAME</id><enabled>Y</enabled><name>FILENAME</name></field><field><id>OBJECT_ID</id><enabled>Y</enabled><name>OBJECT_ID</name></field><field><id>OBJECT_REVISION</id><enabled>Y</enabled><name>OBJECT_REVISION</name></field><field><id>PARENT_CHANNEL_ID</id><enabled>Y</enabled><name>PARENT_CHANNEL_ID</name></field><field><id>ROOT_CHANNEL_ID</id><enabled>Y</enabled><name>ROOT_CHANNEL_ID</name></field></channel-log-table>
<step-log-table><connection/>
<schema/>
<table/>
<timeout_days/>
<field><id>ID_BATCH</id><enabled>Y</enabled><name>ID_BATCH</name></field><field><id>CHANNEL_ID</id><enabled>Y</enabled><name>CHANNEL_ID</name></field><field><id>LOG_DATE</id><enabled>Y</enabled><name>LOG_DATE</name></field><field><id>TRANSNAME</id><enabled>Y</enabled><name>TRANSNAME</name></field><field><id>STEPNAME</id><enabled>Y</enabled><name>STEPNAME</name></field><field><id>STEP_COPY</id><enabled>Y</enabled><name>STEP_COPY</name></field><field><id>LINES_READ</id><enabled>Y</enabled><name>LINES_READ</name></field><field><id>LINES_WRITTEN</id><enabled>Y</enabled><name>LINES_WRITTEN</name></field><field><id>LINES_UPDATED</id><enabled>Y</enabled><name>LINES_UPDATED</name></field><field><id>LINES_INPUT</id><enabled>Y</enabled><name>LINES_INPUT</name></field><field><id>LINES_OUTPUT</id><enabled>Y</enabled><name>LINES_OUTPUT</name></field><field><id>LINES_REJECTED</id><enabled>Y</enabled><name>LINES_REJECTED</name></field><field><id>ERRORS</id><enabled>Y</enabled><name>ERRORS</name></field><field><id>LOG_FIELD</id><enabled>N</enabled><name>LOG_FIELD</name></field></step-log-table>
    </log>
    <maxdate>
      <connection/>
      <table/>
      <field/>
      <offset>0.0</offset>
      <maxdiff>0.0</maxdiff>
    </maxdate>
    <size_rowset>10000</size_rowset>
    <sleep_time_empty>50</sleep_time_empty>
    <sleep_time_full>50</sleep_time_full>
    <unique_connections>N</unique_connections>
    <feedback_shown>Y</feedback_shown>
    <feedback_size>50000</feedback_size>
    <using_thread_priorities>Y</using_thread_priorities>
    <shared_objects_file/>
    <capture_step_performance>N</capture_step_performance>
    <step_performance_capturing_delay>1000</step_performance_capturing_delay>
    <step_performance_capturing_size_limit>100</step_performance_capturing_size_limit>
    <dependencies>
    </dependencies>
    <partitionschemas>
    </partitionschemas>
    <slaveservers>
    </slaveservers>
    <clusterschemas>
    </clusterschemas>
  <created_user>-</created_user>
  <created_date>2016&#47;04&#47;07 11:55:12.079</created_date>
  <modified_user>-</modified_user>
  <modified_date>2016&#47;04&#47;07 11:55:12.079</modified_date>
  </info>
  <notepads>
  </notepads>
  <connection>
    <name>OdsStgDS</name>
    <server/>
    <type>ORACLE</type>
    <access>JNDI</access>
    <database>OdsStgDS</database>
    <port>1521</port>
    <username/>
    <password>Encrypted </password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute><code>FORCE_IDENTIFIERS_TO_LOWERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>FORCE_IDENTIFIERS_TO_UPPERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>IS_CLUSTERED</code><attribute>N</attribute></attribute>
      <attribute><code>PORT_NUMBER</code><attribute>1521</attribute></attribute>
      <attribute><code>QUOTE_ALL_FIELDS</code><attribute>N</attribute></attribute>
      <attribute><code>SUPPORTS_BOOLEAN_DATA_TYPE</code><attribute>N</attribute></attribute>
      <attribute><code>USE_POOLING</code><attribute>N</attribute></attribute>
    </attributes>
  </connection>
  <connection>
    <name>TopazRepDS</name>
    <server/>
    <type>ORACLE</type>
    <access>JNDI</access>
    <database>TopazRepDS</database>
    <port>1521</port>
    <username/>
    <password>Encrypted </password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute><code>FORCE_IDENTIFIERS_TO_LOWERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>FORCE_IDENTIFIERS_TO_UPPERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>IS_CLUSTERED</code><attribute>N</attribute></attribute>
      <attribute><code>PORT_NUMBER</code><attribute>1521</attribute></attribute>
      <attribute><code>QUOTE_ALL_FIELDS</code><attribute>N</attribute></attribute>
      <attribute><code>SUPPORTS_BOOLEAN_DATA_TYPE</code><attribute>N</attribute></attribute>
      <attribute><code>USE_POOLING</code><attribute>N</attribute></attribute>
    </attributes>
  </connection>
  <order>
  <hop> <from>Leo BS_CHARGE_DETAIL</from><to>Cargo T_BS_CHARGE_DETAIL</to><enabled>Y</enabled> </hop>  <hop> <from>Leo BS_PAYS_DETAIL</from><to>Cargo T_BS_PAYS_DETAIL </to><enabled>Y</enabled> </hop>  </order>
  <step>
    <name>Cargo T_BS_CHARGE_DETAIL</name>
    <type>TableOutput</type>
    <description/>
    <distribute>Y</distribute>
    <copies>1</copies>
         <partitioning>
           <method>none</method>
           <schema_name/>
           </partitioning>
    <connection>OdsStgDS</connection>
    <schema>STG</schema>
    <table>T_BS_CHARGE_DETAIL</table>
    <commit>1000</commit>
    <truncate>N</truncate>
    <ignore_errors>N</ignore_errors>
    <use_batch>Y</use_batch>
    <specify_fields>N</specify_fields>
    <partitioning_enabled>N</partitioning_enabled>
    <partitioning_field/>
    <partitioning_daily>N</partitioning_daily>
    <partitioning_monthly>Y</partitioning_monthly>
    <tablename_in_field>N</tablename_in_field>
    <tablename_field/>
    <tablename_in_table>Y</tablename_in_table>
    <return_keys>N</return_keys>
    <return_field/>
    <fields>
    </fields>
     <cluster_schema/>
 <remotesteps>   <input>   </input>   <output>   </output> </remotesteps>    <GUI>
      <xloc>564</xloc>
      <yloc>68</yloc>
      <draw>Y</draw>
      </GUI>
    </step>

  <step>
    <name>Cargo T_BS_PAYS_DETAIL </name>
    <type>TableOutput</type>
    <description/>
    <distribute>Y</distribute>
    <copies>1</copies>
         <partitioning>
           <method>none</method>
           <schema_name/>
           </partitioning>
    <connection>OdsStgDS</connection>
    <schema>STG</schema>
    <table>T_BS_PAYS_DETAIL</table>
    <commit>1000</commit>
    <truncate>N</truncate>
    <ignore_errors>N</ignore_errors>
    <use_batch>Y</use_batch>
    <specify_fields>N</specify_fields>
    <partitioning_enabled>N</partitioning_enabled>
    <partitioning_field/>
    <partitioning_daily>N</partitioning_daily>
    <partitioning_monthly>Y</partitioning_monthly>
    <tablename_in_field>N</tablename_in_field>
    <tablename_field/>
    <tablename_in_table>Y</tablename_in_table>
    <return_keys>N</return_keys>
    <return_field/>
    <fields>
    </fields>
     <cluster_schema/>
 <remotesteps>   <input>   </input>   <output>   </output> </remotesteps>    <GUI>
      <xloc>566</xloc>
      <yloc>159</yloc>
      <draw>Y</draw>
      </GUI>
    </step>

  <step>
    <name>Leo BS_CHARGE_DETAIL</name>
    <type>TableInput</type>
    <description/>
    <distribute>Y</distribute>
    <copies>1</copies>
         <partitioning>
           <method>none</method>
           <schema_name/>
           </partitioning>
    <connection>TopazRepDS</connection>
    <sql>SELECT
	chd.SALDOS_JTS_OID AS SALDO_JTS_OID,
	chd.HP_JTS_OID AS HP_JTS_OID,
	chd.CUOTA AS CUOTA,
	chd.SECUENCIAL_CARGO AS SECUENCIAL_CARGO,
	chd.CARGO_ID AS CARGO_ID,
	chd.COMISION_IMPUESTO AS COMISION_IMPUESTO,
	chd.TOTAL_PAGADO AS TOTAL_PAGADO,
	chd.SALDO_CARGO AS SALDO_CARGO

FROM EDYFICAR.BS_CHARGE_DETAIL chd

WHERE 
		chd.TZ_LOCK=0 AND
		EXISTS (SELECT 1 FROM EDYFICAR.SALDOS s WHERE s.TZ_LOCK=0 AND s.C9314=5 AND s.JTS_OID=chd.SALDOS_JTS_OID)
</sql>
    <limit>0</limit>
    <lookup/>
    <execute_each_row>N</execute_each_row>
    <variables_active>N</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
     <cluster_schema/>
 <remotesteps>   <input>   </input>   <output>   </output> </remotesteps>    <GUI>
      <xloc>106</xloc>
      <yloc>67</yloc>
      <draw>Y</draw>
      </GUI>
    </step>

  <step>
    <name>Leo BS_PAYS_DETAIL</name>
    <type>TableInput</type>
    <description/>
    <distribute>Y</distribute>
    <copies>1</copies>
         <partitioning>
           <method>none</method>
           <schema_name/>
           </partitioning>
    <connection>TopazRepDS</connection>
    <sql>WITH SUBQ1 AS(
              SELECT
                    f.ASIENTO AS ASIENTO,
                    f.SUCURSAL_ASIENTO AS SUCURSAL_ASIENTO,
                    f.FECHA_PROCESO_ASIENTO AS FECHA_PROCESO_ASIENTO,
                    SUM(f.MONTO_IMPONIBLE) AS MONTO_IMPONIBLE
              FROM  EDYFICAR.CI_FACTURA_LINEA f
              WHERE f.ID_CARGO IN (SELECT DISTINCT i.ID_CARGO FROM EDYFICAR.ITF_CODIGOS_SUNAT i)
                    AND f.tz_lock=0
              GROUP BY f.ASIENTO, f.SUCURSAL_ASIENTO, f.FECHA_PROCESO_ASIENTO                          
                    
),
SUBQ2 AS(
              SELECT 
                     SUM(m.V0200) AS V0200,
                     m.ASIENTO AS ASIENTO,
                     m.SUCURSAL AS SUCURSAL,
                     m.FECHAPROCESO AS FECHAPROCESO
              FROM EDYFICAR.MOVIMIENTOS_CONTABLES m
              WHERE m.V0005 IN (SELECT c.C7502 FROM EDYFICAR.CO_CONCEPCONT c WHERE c.C7500 IN (22000003, 22000004))
              GROUP BY m.ASIENTO, m.SUCURSAL, m.FECHAPROCESO                       
),
SUBQ3 AS(
              SELECT
                    itp.CANAL AS CANAL,
                    TO_CHAR(ipp.SUCURSAL) AS SUCURSAL,
					itp.BANCO AS BANCO,	
                    ifl.ASIENTO AS ASIENTO,
                    ifl.FECHA AS FECHA
              FROM 
                  EDYFICAR.INT_PRE_PAGOS ipp
                      JOIN EDYFICAR.INT_FLUJO ifl
                          ON ifl.IDTOPAZ = ipp.IDTOPAZ 
                            AND ifl.FECHA = ipp.FECHA 
                            AND ifl.ESTADO = ipp.ESTADO
                            AND ifl.Tz_Lock=0
                      JOIN EDYFICAR.INT_TEMP_PAGOS itp
                          ON  itp.Cuenta=ipp.cuenta
                            AND itp.moneda=ipp.monedaimporte
                            AND itp.monto=ipp.importe
                            AND itp.Fecha=ipp.fecha
                            AND itp.banco=ipp.banco
                            AND itp.tomado=1 --YA QUE VENGO CON ESTADO=3 QUE ES PROCESADO EL PAGO
                            AND itp.cuentarecauda=ipp.cuentarecauda
                            AND itp.fechavalor=ipp.fechavalor
                            AND itp.transaccion=ipp.transaccion
              WHERE 
                  ipp.tz_lock=0
                  AND ipp.estado=3
              GROUP BY itp.CANAL, TO_CHAR(ipp.SUCURSAL),itp.BANCO, ifl.ASIENTO, ifl.FECHA            
),
SUBQ4 AS(
      SELECT s.JTS_OID AS JTS_OID FROM EDYFICAR.SALDOS s WHERE s.TZ_LOCK=0 AND s.C9314=5
)
SELECT
  pd.SALDOS_JTS_OID AS SALDOS_JTS_OID, 
  pd.HP_JTS_OID AS HP_JTS_OID,
  pd.CUOTA AS CUOTA,
  pd.VENCIMIENTOCUOTA AS VENCIMIENTOCUOTA,
  pd.NROASIENTOMOV AS NROASIENTOMOV,
  pd.SUCURSALMVTO AS SUCURSALMVTO,
  pd.FECHAPROCESOMOV AS FECHAPROCESOMOV,
  pd.FECHAVALOR AS FECHAVALOR,
  pd.CAPITALPAGADO AS CAPITALPAGADO,
  pd.INTERESPAGADO AS INTERESPAGADO,
  pd.INTERESRECALCULADO AS INTERESRECALCULADO,
  pd.CAPITALADELANTADO AS CAPITALADELANTADO,
  pd.MORAPAGADA AS MORAPAGADA,
  pd.BONIFICACION AS BONIFICACION,
  pd.INTERES_COMP_MORA AS INTERES_COMP_MORA,
  NVL(SUBQ1.MONTO_IMPONIBLE,0) AS MO_ITF_PAGA,
  NVL(SUBQ2.V0200,0) AS MO_OTRO_PAGO,
  CASE WHEN pd.SUCURSALMVTO = 12 THEN NVL(SUBQ3.CANAL,&apos; &apos;)
       ELSE &apos; &apos;
   END AS TI_CANAL,
   CASE WHEN pd.SUCURSALMVTO = 12 THEN NVL(SUBQ3.SUCURSAL,&apos; &apos;)
       ELSE &apos; &apos;
   END AS ID_CANAL,
     CASE WHEN pd.SUCURSALMVTO = 12 THEN NVL(SUBQ3.BANCO,&apos; &apos;)
       ELSE &apos; &apos;
   END AS DE_CANA_EXTE	
FROM 
     EDYFICAR.BS_PAYS_DETAIL pd
               JOIN SUBQ4
                  ON SUBQ4.JTS_OID=pd.SALDOS_JTS_OID
                             LEFT JOIN SUBQ1
                                  ON SUBQ1.ASIENTO=pd.NROASIENTOMOV
                                     AND SUBQ1.SUCURSAL_ASIENTO=pd.SUCURSALMVTO
                                     AND SUBQ1.FECHA_PROCESO_ASIENTO=pd.FECHAPROCESOMOV
                             LEFT JOIN SUBQ2
                                  ON SUBQ2.ASIENTO=pd.NROASIENTOMOV
                                     AND SUBQ2.SUCURSAL=pd.SUCURSALMVTO
                                     AND SUBQ2.FECHAPROCESO=pd.FECHAPROCESOMOV
                             LEFT JOIN SUBQ3
                                  ON SUBQ3.ASIENTO=pd.NROASIENTOMOV
                                     AND SUBQ3.FECHA=pd.FECHAPROCESOMOV                                                                          
WHERE
     pd.TZ_LOCK=0</sql>
    <limit>0</limit>
    <lookup/>
    <execute_each_row>N</execute_each_row>
    <variables_active>N</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
     <cluster_schema/>
 <remotesteps>   <input>   </input>   <output>   </output> </remotesteps>    <GUI>
      <xloc>98</xloc>
      <yloc>159</yloc>
      <draw>Y</draw>
      </GUI>
    </step>

  <step_error_handling>
  </step_error_handling>
   <slave-step-copy-partition-distribution>
</slave-step-copy-partition-distribution>
   <slave_transformation>N</slave_transformation>
</transformation>
